{% extends 'CriticCorner/base.html' %}
{% load staticfiles %}

{% block title_block %}
Search
{% endblock %}

{% block body_block %}
<style>
    .filter-section {
        float: left;
        width: 20%;
        padding: 20px;
        border-right: 2px solid #ddd;
    }

    .results-section {
        float: right;
        width: 75%;
        padding: 20px;
    }

    .search-bar-container {
        text-align: center;
        padding: 20px 0;
    }

    .search-input {
        width: 60%;
        padding: 10px;
        font-size: 20px;
        margin-right: -4px;
        border: 2px solid #ddd;
        border-radius: 5px 0 0 5px;
        outline: none;
    }

    .search-button {
        padding: 12px 20px;
        font-size: 20px;
        border: none;
        background-color: #333;
        color: white;
        cursor: pointer;
        border-radius: 0 5px 5px 0;
    }

    .search-button:hover {
        background-color: #555;
    }

    .filter-title {
        margin-bottom: 10px;
        font-weight: bold;
    }

    .filter-group {
        margin-bottom: 20px;
    }

    .filter-checkbox {
        margin-right: 5px;
    }

    .result-item {
        margin-bottom: 10px;

        background: #ccc;
        width: 100%;
        padding-top: 56.25%;

        position: relative;
    }

    .sort-section {
        text-align: right;
        margin-bottom: 10px;
    }


    .clearfix::after {
        content: "";
        clear: both;
        display: table;
    }

    .movie-card {
        display: inline-block; /* Display movie cards inline */
        margin-right: 20px; /* Adjust margin between movie cards */
        text-align: center; /* Center-align the content within each movie card */
        width: 220px; /* Set a fixed width for movie cards */
        height: 380px; /* Set a fixed height for movie cards */
        position: relative; /* Positioning for title */
    }

    .movie-card img {
        width: 200px; /* Adjust width of movie poster */
        height: 300px; /* Adjust height of movie poster */
        object-fit: cover; /* Maintain aspect ratio and fill the container */
    }

    .no-poster {
        width: 200px; /* Adjust width of placeholder */
        height: 300px; /* Adjust height of placeholder */
        background-color: #ccc; /* Placeholder background color */
        display: flex;
        align-items: center; /* Center-align content vertically */
        justify-content: center; /* Center-align content horizontally */
    }

    .movie-title {
        display: block; /* Display the title on a new line */
        margin-top: 10px; /* Adjust spacing between the poster and title */
    }

    a {
        color: black;
    }
</style>

<div class="clearfix">
    <div class="filter-section">
        <div class="filter-title">BY Genre</div>
        <div class="filter-group" id="genre-filter">

            <label><input type="checkbox" class="filter-checkbox">Action</label><br>
            <label><input type="checkbox" class="filter-checkbox">Comedy</label><br>
            <label><input type="checkbox" class="filter-checkbox">Horror</label><br>
            <label><input type="checkbox" class="filter-checkbox">Science</label><br>
            <label><input type="checkbox" class="filter-checkbox">Crime</label><br>
            <label><input type="checkbox" class="filter-checkbox">Drama</label><br>
            <label><input type="checkbox" class="filter-checkbox">Fantasy</label><br>
            <label><input type="checkbox" class="filter-checkbox">Romance</label><br>
        </div>
        <div class="filter-title">BY Release Date</div>
<div class="filter-group" id="release-date-filter">
    <label><input type="checkbox" class="filter-checkbox" value="3_months">Within 3 months</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="1_year">Within 1 year</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="5_years">Within 5 years</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="10_years">Within 10 years</label><br>
</div>
<div class="filter-title">BY Language</div>
<div class="filter-group" id="language-filter">
    <label><input type="checkbox" class="filter-checkbox" value="en">English</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="zh">Chinese</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="fr">French</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="de">German</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="it">Italian</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="ja">Japanese</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="ko">Korean</label><br>
    <label><input type="checkbox" class="filter-checkbox" value="es">Spanish</label><br>
</div>
        <button id="filter-button">Apply Filters</button>
    </div>

    <div class="sort-section">
        <select id="sort-select">
            <option value="default">Default</option>
            <option value="popularity">Popularity</option>
            <option value="release_date">Release Date</option>
        </select>
        <button id="sort-button">Sort</button>
    </div>
    <div class="results-section">
        <h3>Search Results for "{{ query }}":</h3>
        <div class="movies-container" id="movies-container">
            {% if sort_by == "popularity" %}
                {% for movie in movies_popularity %}
                    <div class="movie-card" data-movie-slug="{{ movie.slug }}">
                        {% if movie.poster_path %}
                            <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }} Poster">
                        {% else %}
                            <div class="no-poster"></div>
                        {% endif %}
                        <span class="title">{{ movie.title }}</span>
                    </div>
                {% endfor %}
            {% elif sort_by == "release_date" %}
                {% for movie in movies_release %}
                    <div class="movie-card" data-movie-slug="{{ movie.slug }}">
                        {% if movie.poster_path %}
                            <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }} Poster">
                        {% else %}
                            <div class="no-poster"></div>
                        {% endif %}
                        <span class="title">{{ movie.title }}</span>
                    </div>
                {% endfor %}
            {% else %}
                {% for movie in movies_default %}
                    <div class="movie-card" data-movie-slug="{{ movie.slug }}">
                        {% if movie.poster_path %}
                            <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }} Poster">
                        {% else %}
                            <div class="no-poster"></div>
                        {% endif %}
                        <span class="title">{{ movie.title }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("sort-button").addEventListener("click", function() {
                var select = document.getElementById("sort-select");
                var selectedOption = select.options[select.selectedIndex].value;
                
                // Redirect to the appropriate URL based on the selected sorting option
                if (selectedOption === "popularity") {
                    window.location.href = "{% url 'CriticCorner:search' %}?q={{ query }}&sort_by=popularity";
                } else if (selectedOption === "release_date") {
                    window.location.href = "{% url 'CriticCorner:search' %}?q={{ query }}&sort_by=release_date";
                } else {
                    // Default sorting
                    window.location.href = "{% url 'CriticCorner:search' %}?q={{ query }}";
                }
            });
        });

        // Function to handle clicking on a movie poster
    function handleMovieClick(movieSlug) {
        // Get CSRF token
        var csrftoken = getCookie('csrftoken');
        
        // Send AJAX request to add the movie to the database
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "{% url 'CriticCorner:add_movie' %}", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("X-CSRFToken", csrftoken); // Set CSRF token in headers
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                // Movie added successfully
                alert("Movie added to your local database!");
            }
        };
        xhr.send(JSON.stringify({ slug: movieSlug }));
    }

    // Add click event listeners to movie cards
    document.addEventListener("DOMContentLoaded", function() {
        var movieCards = document.querySelectorAll(".movie-card");
        movieCards.forEach(function(card) {
            card.addEventListener("click", function() {
                var movieSlug = card.getAttribute("data-movie-slug");
                handleMovieClick(movieSlug);
            });
        });
    });

    // Function to get CSRF token from cookies
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById("filter-button").addEventListener("click", function() {
    var selectedGenres = [];
    var selectedReleaseDates = [];
    var selectedLanguages = [];

    // Get selected genres
    document.querySelectorAll("#genre-filter .filter-checkbox:checked").forEach(function(checkbox) {
        selectedGenres.push(checkbox.value);
    });

    // Get selected release dates
    document.querySelectorAll("#release-date-filter .filter-checkbox:checked").forEach(function(checkbox) {
        selectedReleaseDates.push(checkbox.value);
    });

    // Get selected languages
    document.querySelectorAll("#language-filter .filter-checkbox:checked").forEach(function(checkbox) {
        selectedLanguages.push(checkbox.value);
    });

    // Construct URL with selected filters
    var url = "{% url 'CriticCorner:search' %}?q={{ query }}&sort_by={{ sort_by }}";

    if (selectedGenres.length > 0) {
        url += "&genres=" + selectedGenres.join(",");
    }

    if (selectedReleaseDates.length > 0) {
        url += "&release_dates=" + selectedReleaseDates.join(",");
    }

    if (selectedLanguages.length > 0) {
        url += "&languages=" + selectedLanguages.join(",");
    }

    window.location.href = url;
});
    </script>
{% endblock %}